@using Draft.Components.Layout
@layout StaffLayout
@page "/PlaceOrder"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Staff")]
@using Draft.Components.Models
@* @inject IJSRuntime JsRuntime *@

<h3>Place Order</h3>

<EditForm Model="@_order" OnValidSubmit="@HandleValidSubmit">
    <div class="form-group">
        <label for="coffeeId">Select Coffee:</label>
        <InputSelect id="coffeeId" @bind-Value="@_order.CoffeeId" class="form-control">
            @if (_coffeesList != null)
            {
                foreach (var coffee in _coffeesList)
                {
                    <option value="@coffee.Guid">@coffee.CoffeeName - $@coffee.Price</option>
                }
            }
        </InputSelect>
    </div>
    <div class="form-group">
       <label>Add-Ons:</label>
       @if (_addOnsList != null)
       {
           foreach (var addOn in _addOnsList)
           {
               <div class="form-check">
                   <input class="form-check-input" type="checkbox" value="@addOn.Guid" @onchange="(e) => ToggleAddOn(e, addOn.Guid)" />
                   <label class="form-check-label">@addOn.AddOnName - $@addOn.AddOnPrice</label>
               </div>
           }
       }
    </div>

    <div class="form-group">
        <label for="quantity">Quantity:</label>
        <InputNumber id="quantity" @bind-Value="@_order.Quantity" class="form-control" />
    </div>
    <div class="form-group">
        <label for="searchPhoneNo">Search by Phone Number:</label>
        <InputText id="searchPhoneNo" @bind-Value="@_order.CustomerPhone" class="form-control" @oninput="FilterCustomers" />
        @* <button type="button" class="btn btn-primary" @onclick="FilterCustomers">Search</button> *@
    </div>
    <button class="btn btn-primary" @onclick="@AddToList">Add Another</button>
    <button type="submit" class="btn btn-primary">Submit</button>
</EditForm>
@foreach (var orders in _ordersList)
{
    <li>@orders.</li>
}

@code {
    private Order _order = new Order();
    private List<Coffees>? _coffeesList = new List<Coffees>();
    private List<CoffeeAddOns>? _addOnsList = new List<CoffeeAddOns>();
    private List<Customers>? _customersList = new List<Customers>();
    private List<Order>? _ordersList = new List<Order>();

    private string _searchPhoneNo = "";
    private List<Customers> _filteredCustomers = [];

    void ToggleAddOn(ChangeEventArgs e, Guid addOnId)
    {
        var isChecked = (bool)e.Value;
        if (isChecked)
        {
            _order.AddOnIds.Add(addOnId);
        }
        else
        {
            _order.AddOnIds.Remove(addOnId);
        }
    }


    private void FilterCustomers()
    {
        if (_customersList != null) _filteredCustomers = _customersList.Where(c => c.PhoneNo != null && c.PhoneNo.Contains(_searchPhoneNo)).ToList();
    }

    public void AddToList()
    {
        if (_order.CoffeeId != null)
        {
            _ordersList.Add(new Order
            {
                Id = new Guid(),
                CoffeeId = _order.CoffeeId,
                AddOnIds = _order.AddOnIds,
                CustomerPhone = _order.CustomerPhone,
                Quantity = _order.Quantity,
                TotalPrice = CalculateTotalPrice()
            });
        }
    }
    
    private async Task HandleValidSubmit()
    {
        // Calculate the total price and apply discounts
        // _order.TotalPrice = CalculateTotalPrice(_order);
        _order.CreatedAt = DateTime.Now;
        // _order.Id = Guid.NewGuid();

        // Save the order
        // await SaveOrder(_order);

        // Reset the form
        _order = new Order();
    }
    
    private double CalculateTotalPrice()
    {
        var coffeePrice = _coffeesList.FirstOrDefault(c => c.Guid == _order.CoffeeId)?.Price ?? 0;
        var addOnsPrice = _order.AddOnIds.Sum(addOnId => _addOnsList.FirstOrDefault(a => a.Guid == addOnId)?.AddOnPrice ?? 0);
        return (coffeePrice + addOnsPrice) * _order.Quantity;
    }

    // private double CalculateTotalPrice(Order order)
    // {
    //     if (_coffeesList == null) return 0;
    //     var basePrice = _coffeesList.First(c => c.Guid == order.CoffeeId).Price;
    //     var addOnsPrice = order.AddOnIds.Sum(id =>
    //     {
    //         if (_addOnsList != null) return _addOnsList.First(a => a.Guid == id).AddOnPrice;
    //         return 0;
    //     });
    //     var priceBeforeDiscount = (basePrice + addOnsPrice) * order.Quantity;
    //
    //     // Check if the customer is a regular customer (e.g., by phone number)
    //     // if (_customersList != null)
    //     // {
    //     //     var customer = _customersList.FirstOrDefault(c => c.PhoneNo == order.CustomerPhone);
    //     // }
    //         
    //
    //     return priceBeforeDiscount;
    //
    // }

    private static async Task SaveOrder(Order order)
    {
        var directoryPath = ConstantValues.FilePath;
        var ordersFile = ConstantValues.OrdersPath;

        // Ensure the directory exists
        Directory.CreateDirectory(directoryPath);

        // Initialize allOrders either from the existing file or as a new instance
        AllOrders allOrders = File.Exists(ordersFile)
            ? JsonSerializer.Deserialize<AllOrders>(await File.ReadAllTextAsync(ordersFile)) ?? new AllOrders()
            : new AllOrders();

        // Add the new order to the list
        allOrders.OrdersList.Add(order);

        // Serialize the list to JSON and write it to the file
        string newJson = JsonSerializer.Serialize(allOrders);
        await File.WriteAllTextAsync(ordersFile, newJson);
    }

    protected override async Task OnInitializedAsync()
    {
        var coffeeFile = ConstantValues.CoffeePath;
        var addOnsFile = ConstantValues.AddOnsPath;
        var customersFile = ConstantValues.CustomerPath;

        if (File.Exists(coffeeFile))
        {
            try
            {
                var jsonFromFile = await File.ReadAllTextAsync(coffeeFile);
                AllCoffees? allCoffees = JsonSerializer.Deserialize<AllCoffees>(jsonFromFile);

                if (allCoffees != null)
                {
                    _coffeesList = allCoffees.CoffeesList;
                }
            }
            catch (Exception e)
            {
                // Handle exceptions here, such as logging or displaying an error message
                Console.WriteLine($"An error occurred while reading the file: {e.Message}");
            }
        }

        if (File.Exists(addOnsFile))
        {
            try
            {
                string jsonFromFile = await File.ReadAllTextAsync(addOnsFile);
                AllListOfCoffeeAddOns? allAddOns = JsonSerializer.Deserialize<AllListOfCoffeeAddOns>(jsonFromFile);

                if (allAddOns != null)
                {
                    _addOnsList = allAddOns.AddOnsList;
                }
            }
            catch (Exception e)
            {
                // Handle exceptions here, such as logging or displaying an error message
                Console.WriteLine($"An error occurred while reading the file: {e.Message}");
            }
        }

        if (File.Exists(customersFile))
        {
            try
            {
                string jsonFromFile = await File.ReadAllTextAsync(customersFile);
                AllCustomerList? allCustomers = JsonSerializer.Deserialize<AllCustomerList>(jsonFromFile);

                if (allCustomers != null)
                {
                    _customersList = allCustomers.AllCustomer;
                }
            }
            catch (Exception e)
            {
                // Handle exceptions here, such as logging or displaying an error message
                Console.WriteLine($"An error occurred while reading the file: {e.Message}");
            }
        }
    }
}